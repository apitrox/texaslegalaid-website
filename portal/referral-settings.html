<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Referral Settings - Provider Portal | Texas Legal Aid</title>
  <meta name="description" content="Configure your referral acceptance criteria for each Referral Channel.">
  <meta name="robots" content="noindex, nofollow">
  <link rel="canonical" href="https://texaslegalaid.org/portal/referral-settings.html">
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#2D5A7B">
  <link rel="icon" type="image/png" href="../images/TLA_Favicon_Solid_White.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Source+Serif+4:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50:'#E8F2F8',100:'#D0E4F2',200:'#B8D4E8',300:'#9DB4C7',400:'#778DA9',500:'#415A77',600:'#2D5A7B',700:'#1B263B',800:'#0D1B2A' },
            secondary: { 100:'#FDF8E8',200:'#F5E4B8',300:'#EBD095',400:'#E0BC74',500:'#D4A853' }
          },
          fontFamily: {
            display: ['"Source Serif 4"','Georgia','serif'],
            body: ['"IBM Plex Sans"','-apple-system','sans-serif']
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="../css/custom.css">
  <style>
    .portal-layout{display:grid;grid-template-columns:var(--sidebar-width, 260px) 1fr;min-height:calc(100vh - 64px)}
    @media(max-width:1023px){.portal-layout{grid-template-columns:1fr}}
    .sidebar-resize-handle{position:absolute;right:0;top:0;bottom:0;width:4px;cursor:ew-resize;background:transparent;transition:background 0.2s;z-index:10}
    .sidebar-resize-handle:hover,.sidebar-resize-handle.dragging{background:#2D5A7B}
    .sidebar-link.active{background:#2D5A7B;color:white}
    .collapsible-header{cursor:pointer;user-select:none}
    .collapsible-content{max-height:0;overflow:hidden;transition:max-height 0.3s ease}
    .collapsible-section.open .collapsible-content{max-height:3000px;overflow:visible}
    .collapsible-section.open .twistie{transform:rotate(90deg)}
    .twistie{transition:transform 0.2s ease}
    input[type="range"]{-webkit-appearance:none;width:100%;height:8px;border-radius:4px;background:#e5e7eb;outline:none}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#2D5A7B;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
    .toggle-switch{position:relative;width:48px;height:24px}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#e5e7eb;border-radius:24px;transition:0.3s}
    .toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;border-radius:50%;transition:0.3s}
    .toggle-switch input:checked+.toggle-slider{background-color:#2D5A7B}
    .toggle-switch input:checked+.toggle-slider:before{transform:translateX(24px)}
    .summary-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:#f3f4f6;border-radius:9999px;font-size:12px;color:#4b5563}
    .multi-select-dropdown{position:relative;width:100%}
    .multi-select-selected{min-height:44px;padding:8px 12px;border:2px solid #d1d5db;border-radius:8px;background:white;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
    .multi-select-selected:focus{border-color:#2D5A7B;outline:none}
    .multi-select-options{position:absolute;top:100%;left:0;right:0;max-height:300px;overflow-y:auto;background:white;border:2px solid #2D5A7B;border-radius:8px;margin-top:4px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:100;display:none}
    .multi-select-options.open{display:block}
    .multi-select-option{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px}
    .multi-select-option:hover{background:#f3f4f6}
    .multi-select-option.all-option{border-bottom:2px solid #e5e7eb;font-weight:600;background:#f9fafb}
    .multi-select-option input[type="checkbox"]{width:18px;height:18px;cursor:pointer;accent-color:#2D5A7B}
    .multi-select-search{padding:8px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;background:white;z-index:1}
    .multi-select-search input{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px}
    .settings-group{border:2px solid #e5e7eb;border-radius:12px;padding:20px;background:#f9fafb;margin-top:20px}
    .settings-group-header{display:flex;align-items:center;gap:8px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb}
    .settings-group-title{font-size:16px;font-weight:600;color:#1B263B}
    .notification-option{display:flex;flex-direction:column;gap:8px;padding:14px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:12px;background:white;transition:border-color 0.2s}
    .notification-option:last-child{margin-bottom:0}
    .notification-option.checked{border-color:#2D5A7B;background:#f8fafc}
    .notification-option-header{display:flex;align-items:center;gap:12px}
    .notification-option-header input[type="checkbox"]{width:20px;height:20px;cursor:pointer;accent-color:#2D5A7B}
    .notification-input-field{margin-top:8px;display:none;padding-left:32px}
    .notification-input-field.active{display:block}
    .notification-input-field input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px}
    .notification-input-field input:focus{border-color:#2D5A7B;outline:none;box-shadow:0 0 0 3px rgba(45,90,123,0.1)}
    .notification-description{font-size:12px;color:#6b7280;padding-left:32px;margin-top:4px}
    .county-display{display:flex;flex-wrap:wrap;gap:6px;max-width:100%}
    .county-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:#2D5A7B;color:white;border-radius:4px;font-size:13px}
    .county-count{color:#6b7280;font-size:13px}
    .updated-indicator{display:inline-block;width:8px;height:8px;background:#D4A853;border-radius:50%;margin-left:8px;animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
  </style>
</head>
<body class="font-body text-gray-800 bg-gray-100">
  <a href="#main-content" class="skip-link">Skip to main content</a>
  
  <div class="trial-banner" role="alert">
    <div class="container flex items-center justify-between">
      <p><strong>Prototype Mode:</strong> This is a preview of the provider portal in prototype mode. In prototype mode, several features in the provider portal are intentionally configured to not be fully functional.</p>
    </div>
  </div>

  <div class="portal-layout">
    <aside class="bg-white border-r border-gray-200 hidden lg:block relative" id="portal-sidebar">
      <div class="sidebar-resize-handle" id="sidebar-resizer"></div>
      <nav class="p-4" aria-label="Portal navigation">
        <ul class="space-y-1">
          <li><a href="analytics-dashboard.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>Analytics Dashboard</a></li>
          <li><a href="referral-settings.html" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>Referral Settings</a></li>
          <li><a href="referred-cases.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Referred Cases</a></li>
          <li><a href="provider-profile.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>Provider Profile</a></li>
          <li><a href="team-members.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>Team Members</a></li>
          <li><a href="messages.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>Messages<span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full ml-auto">3</span></a></li>
          <li><a href="integrations.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/></svg>Integrations</a></li>
        </ul>
        <hr class="my-4">
        <ul><li><a href="index.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>Sign Out</a></li></ul>
      </nav>
    </aside>

    <main id="main-content" class="p-6 pb-24 lg:pb-6">
      <div class="mb-6 flex items-center gap-4">
        <img src="../images/TLA_Logo_White.png" alt="Texas Legal Aid" class="w-24 h-24 rounded-full">
        <div>
          <h1 class="text-2xl font-bold text-primary-800">Referral Settings</h1>
          <p class="text-lg font-semibold text-gray-700">Demo Legal Aid Organization</p>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-sm p-6 mb-4">
        <p class="text-gray-600 mb-4">Configure your referral acceptance criteria for each Referral Channel. A Referral Channel defines how your organization receives and processes client referrals based on case type, poverty level, geographic area, and capacity. Click a channel to expand and edit its settings. A referral will be sent to a Provider only once, even if it meets the settings of multiple Referral Channels. All updates are evaluated in real-time immediately after being saved.</p>
        <button onclick="alert('This button is not fully functional for the purposes of this prototype.')" class="text-sm px-3 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 transition-colors">+ Add Referral Channel</button>
      </div>
      <div class="space-y-4" id="referral-sections"></div>
    </main>
  </div>

  <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-2 z-40">
    <ul class="flex justify-around">
      <li><a href="analytics-dashboard.html" class="flex flex-col items-center gap-1 p-2 text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span class="text-xs">Home</span></a></li>
      <li><a href="cases.html" class="flex flex-col items-center gap-1 p-2 text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><span class="text-xs">Cases</span></a></li>
      <li><a href="messages.html" class="flex flex-col items-center gap-1 p-2 text-gray-600 relative"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg><span class="text-xs">Messages</span><span class="absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full"></span></a></li>
      <li><a href="provider-profile.html" class="flex flex-col items-center gap-1 p-2 text-primary-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><span class="text-xs font-medium">Profile</span></a></li>
    </ul>
  </nav>

  <script src="../js/main.js"></script>
  <script>
    // Comprehensive list of case types served by legal aid organizations (alphabetically sorted)
    const allCaseTypes = [
      'ADA Accommodations',
      'Adoption',
      'Asylum',
      'Bankruptcy',
      'Benefits Appeals',
      'Child Custody',
      'Child Support',
      'Consumer Protection',
      'DACA Renewal',
      'Debt Collection Defense',
      'Disability Benefits',
      'Divorce',
      'Domestic Violence',
      'Elder Abuse',
      'Employment Discrimination',
      'Eviction Defense',
      'Expunction/Record Clearing',
      'Fair Housing',
      'Family Petitions',
      'Foreclosure Prevention',
      'Foster Care Issues',
      'Guardianship',
      'Habitability',
      'Healthcare Access',
      'Immigration Detention',
      'Landlord/Tenant Disputes',
      'Medicaid/Medicare Issues',
      'Name Change',
      'Naturalization',
      'Paternity',
      'Power of Attorney',
      'Protective Orders',
      'Public Benefits',
      'Section 8',
      'Special Education',
      'SSI/SSDI Appeals',
      'Tax Controversies',
      'TANF Issues',
      'Unemployment Benefits',
      'Veterans Benefits',
      'Victims of Crime',
      'Wage Theft',
      'Wills and Estates',
      'Workers Compensation'
    ];

    // Referral sections data
    // Texas counties sorted alphabetically with population rank (1 = most populous, for display ordering)
    const texasCounties = [
      {name:'Anderson',popRank:75},{name:'Andrews',popRank:117},{name:'Angelina',popRank:54},{name:'Aransas',popRank:128},{name:'Archer',popRank:181},
      {name:'Armstrong',popRank:240},{name:'Atascosa',popRank:63},{name:'Austin',popRank:106},{name:'Bailey',popRank:196},{name:'Bandera',popRank:121},
      {name:'Bastrop',popRank:42},{name:'Baylor',popRank:222},{name:'Bee',popRank:102},{name:'Bell',popRank:17},{name:'Bexar',popRank:4},
      {name:'Blanco',popRank:152},{name:'Borden',popRank:254},{name:'Bosque',popRank:136},{name:'Bowie',popRank:56},{name:'Brazoria',popRank:13},
      {name:'Brazos',popRank:26},{name:'Brewster',popRank:185},{name:'Briscoe',popRank:241},{name:'Brooks',popRank:190},{name:'Brown',popRank:91},
      {name:'Burleson',popRank:135},{name:'Burnet',popRank:64},{name:'Caldwell',popRank:68},{name:'Calhoun',popRank:126},{name:'Callahan',popRank:155},
      {name:'Cameron',popRank:15},{name:'Camp',popRank:160},{name:'Carson',popRank:204},{name:'Cass',popRank:103},{name:'Castro',popRank:193},
      {name:'Chambers',popRank:57},{name:'Cherokee',popRank:67},{name:'Childress',popRank:194},{name:'Clay',popRank:169},{name:'Cochran',popRank:229},
      {name:'Coke',popRank:218},{name:'Coleman',popRank:175},{name:'Collin',popRank:6},{name:'Collingsworth',popRank:227},{name:'Colorado',popRank:119},
      {name:'Comal',popRank:21},{name:'Comanche',popRank:154},{name:'Concho',popRank:223},{name:'Cooke',popRank:78},{name:'Coryell',popRank:48},
      {name:'Cottle',popRank:248},{name:'Crane',popRank:189},{name:'Crockett',popRank:213},{name:'Crosby',popRank:202},{name:'Culberson',popRank:231},
      {name:'Dallam',popRank:195},{name:'Dallas',popRank:2},{name:'Dawson',popRank:161},{name:'Deaf Smith',popRank:139},{name:'Delta',popRank:200},
      {name:'Denton',popRank:7},{name:'DeWitt',popRank:114},{name:'Dickens',popRank:238},{name:'Dimmit',popRank:168},{name:'Donley',popRank:212},
      {name:'Duval',popRank:170},{name:'Eastland',popRank:137},{name:'Ector',popRank:29},{name:'Edwards',popRank:234},{name:'Ellis',popRank:20},
      {name:'El Paso',popRank:8},{name:'Erath',popRank:73},{name:'Falls',popRank:140},{name:'Fannin',popRank:88},{name:'Fayette',popRank:96},
      {name:'Fisher',popRank:215},{name:'Floyd',popRank:199},{name:'Foard',popRank:247},{name:'Fort Bend',popRank:9},{name:'Franklin',popRank:171},
      {name:'Freestone',popRank:131},{name:'Frio',popRank:134},{name:'Gaines',popRank:118},{name:'Galveston',popRank:18},{name:'Garza',popRank:205},
      {name:'Gillespie',popRank:97},{name:'Glasscock',popRank:250},{name:'Goliad',popRank:191},{name:'Gonzales',popRank:111},{name:'Gray',popRank:127},
      {name:'Grayson',popRank:28},{name:'Gregg',popRank:33},{name:'Grimes',popRank:99},{name:'Guadalupe',popRank:22},{name:'Hale',popRank:86},
      {name:'Hall',popRank:225},{name:'Hamilton',popRank:174},{name:'Hansford',popRank:206},{name:'Hardeman',popRank:217},{name:'Hardin',popRank:61},
      {name:'Harris',popRank:1},{name:'Harrison',popRank:53},{name:'Hartley',popRank:203},{name:'Haskell',popRank:201},{name:'Hays',popRank:16},
      {name:'Hemphill',popRank:216},{name:'Henderson',popRank:47},{name:'Hidalgo',popRank:5},{name:'Hill',popRank:82},{name:'Hockley',popRank:122},
      {name:'Hood',popRank:52},{name:'Hopkins',popRank:81},{name:'Houston',popRank:124},{name:'Howard',popRank:89},{name:'Hudspeth',popRank:219},
      {name:'Hunt',popRank:35},{name:'Hutchinson',popRank:115},{name:'Irion',popRank:245},{name:'Jack',popRank:178},{name:'Jackson',popRank:157},
      {name:'Jasper',popRank:87},{name:'Jeff Davis',popRank:237},{name:'Jefferson',popRank:24},{name:'Jim Hogg',popRank:209},{name:'Jim Wells',popRank:76},
      {name:'Johnson',popRank:23},{name:'Jones',popRank:130},{name:'Karnes',popRank:143},{name:'Kaufman',popRank:25},{name:'Kendall',popRank:69},
      {name:'Kenedy',popRank:253},{name:'Kent',popRank:251},{name:'Kerr',popRank:60},{name:'Kimble',popRank:208},{name:'King',popRank:252},
      {name:'Kinney',popRank:221},{name:'Kleberg',popRank:100},{name:'Knox',popRank:214},{name:'Lamar',popRank:62},{name:'Lamb',popRank:149},
      {name:'Lampasas',popRank:113},{name:'La Salle',popRank:192},{name:'Lavaca',popRank:132},{name:'Lee',popRank:120},{name:'Leon',popRank:129},
      {name:'Liberty',popRank:41},{name:'Limestone',popRank:125},{name:'Lipscomb',popRank:236},{name:'Live Oak',popRank:164},{name:'Llano',popRank:116},
      {name:'Loving',popRank:255},{name:'Lubbock',popRank:14},{name:'Lynn',popRank:198},{name:'Madison',popRank:156},{name:'Marion',popRank:180},
      {name:'Martin',popRank:183},{name:'Mason',popRank:210},{name:'Matagorda',popRank:85},{name:'Maverick',popRank:55},{name:'McCulloch',popRank:176},
      {name:'McLennan',popRank:19},{name:'McMullen',popRank:249},{name:'Medina',popRank:59},{name:'Menard',popRank:235},{name:'Midland',popRank:27},
      {name:'Milam',popRank:101},{name:'Mills',popRank:188},{name:'Mitchell',popRank:179},{name:'Montague',popRank:112},{name:'Montgomery',popRank:10},
      {name:'Moore',popRank:108},{name:'Morris',popRank:163},{name:'Motley',popRank:243},{name:'Nacogdoches',popRank:51},{name:'Navarro',popRank:58},
      {name:'Newton',popRank:167},{name:'Nolan',popRank:142},{name:'Nueces',popRank:12},{name:'Ochiltree',popRank:173},{name:'Oldham',popRank:233},
      {name:'Orange',popRank:43},{name:'Palo Pinto',popRank:98},{name:'Panola',popRank:123},{name:'Parker',popRank:30},{name:'Parmer',popRank:184},
      {name:'Pecos',popRank:141},{name:'Polk',popRank:65},{name:'Potter',popRank:44},{name:'Presidio',popRank:197},{name:'Rains',popRank:159},
      {name:'Randall',popRank:32},{name:'Reagan',popRank:220},{name:'Real',popRank:224},{name:'Red River',popRank:165},{name:'Reeves',popRank:145},
      {name:'Refugio',popRank:197},{name:'Roberts',popRank:246},{name:'Robertson',popRank:138},{name:'Rockwall',popRank:45},{name:'Runnels',popRank:172},
      {name:'Rusk',popRank:66},{name:'Sabine',popRank:166},{name:'San Augustine',popRank:186},{name:'San Jacinto',popRank:104},{name:'San Patricio',popRank:50},
      {name:'San Saba',popRank:207},{name:'Schleicher',popRank:226},{name:'Scurry',popRank:133},{name:'Shackelford',popRank:228},{name:'Shelby',popRank:107},
      {name:'Sherman',popRank:230},{name:'Smith',popRank:31},{name:'Somervell',popRank:177},{name:'Starr',popRank:49},{name:'Stephens',popRank:182},
      {name:'Sterling',popRank:244},{name:'Stonewall',popRank:242},{name:'Sutton',popRank:211},{name:'Swisher',popRank:187},{name:'Tarrant',popRank:3},
      {name:'Taylor',popRank:34},{name:'Terrell',popRank:239},{name:'Terry',popRank:153},{name:'Throckmorton',popRank:246},{name:'Titus',popRank:83},
      {name:'Tom Green',popRank:37},{name:'Travis',popRank:11},{name:'Trinity',popRank:147},{name:'Tyler',popRank:144},{name:'Upshur',popRank:77},
      {name:'Upton',popRank:232},{name:'Uvalde',popRank:95},{name:'Val Verde',popRank:70},{name:'Van Zandt',popRank:72},{name:'Victoria',popRank:39},
      {name:'Walker',popRank:46},{name:'Waller',popRank:38},{name:'Ward',popRank:150},{name:'Washington',popRank:90},{name:'Webb',popRank:36},
      {name:'Wharton',popRank:74},{name:'Wheeler',popRank:199},{name:'Wichita',popRank:40},{name:'Wilbarger',popRank:148},{name:'Willacy',popRank:151},
      {name:'Williamson',popRank:12},{name:'Wilson',popRank:71},{name:'Winkler',popRank:189},{name:'Wise',popRank:46},{name:'Wood',popRank:79},
      {name:'Yoakum',popRank:162},{name:'Young',popRank:146},{name:'Zapata',popRank:158},{name:'Zavala',popRank:167}
    ];

    const sections = [
      {id:'cvcls',name:'Crime Victim Civil Legal Services (CVCLS)',color:'red',cases:['Victims of Crime','Protective Orders','Domestic Violence'],counties:['Harris','Dallas','Tarrant','Travis','Bexar','El Paso','Denton','Collin'],allCounties:false,fpl:187.5,daily:2,weekly:5,monthly:10,attestation:true,active:true,notifyText:true,notifyTextValue:'512-555-9999',notifyEmail:false,notifyEmailValue:'',notifyWebhook:true,notifyWebhookValue:'https://api.example.org/cvcls-referrals'},
      {id:'disability',name:'Disability Rights',color:'teal',cases:['SSI/SSDI Appeals','ADA Accommodations','Special Education'],counties:['Harris','Travis','Dallas'],allCounties:false,fpl:125,daily:5,weekly:20,monthly:40,attestation:true,active:true,notifyText:true,notifyTextValue:'512-555-1234',notifyEmail:true,notifyEmailValue:'intake@example.org',notifyWebhook:false,notifyWebhookValue:''},
      {id:'family',name:'Family Law',color:'purple',cases:['Child Custody','Divorce','Child Support','Adoption'],counties:[],allCounties:true,fpl:125,daily:8,weekly:30,monthly:60,attestation:true,active:true,notifyText:false,notifyTextValue:'',notifyEmail:true,notifyEmailValue:'family@example.org',notifyWebhook:false,notifyWebhookValue:''},
      {id:'housing',name:'Housing',color:'orange',cases:['Eviction Defense','Fair Housing','Habitability','Section 8'],counties:['Harris','Dallas','Tarrant','Bexar'],allCounties:false,fpl:125,daily:6,weekly:25,monthly:50,attestation:true,active:true,notifyText:false,notifyTextValue:'',notifyEmail:true,notifyEmailValue:'housing@example.org',notifyWebhook:false,notifyWebhookValue:''},
      {id:'immigration',name:'Immigration',color:'blue',cases:['DACA Renewal','Asylum','Family Petitions','Naturalization'],counties:['Bexar','El Paso','Hidalgo','Cameron','Webb'],allCounties:false,fpl:125,daily:4,weekly:15,monthly:35,attestation:false,active:true,notifyText:true,notifyTextValue:'210-555-5678',notifyEmail:false,notifyEmailValue:'',notifyWebhook:true,notifyWebhookValue:'https://api.example.org/referrals'}
    ];

    // Helper function to get county display text
    function getCountyDisplayText(counties, allCounties) {
      if (allCounties) return 'All counties';
      if (counties.length === 0) return 'Select counties...';
      
      // Get the 5 most populous counties from the selection, sorted by population rank
      const sortedByPopulation = [...counties].sort((a, b) => {
        const aCounty = texasCounties.find(c => c.name === a);
        const bCounty = texasCounties.find(c => c.name === b);
        return (aCounty?.popRank || 999) - (bCounty?.popRank || 999);
      });
      
      // Take up to 5 most populous, then sort those alphabetically for display
      const topCounties = sortedByPopulation.slice(0, 5).sort((a, b) => a.localeCompare(b));
      
      if (counties.length <= 5) {
        return topCounties.join(', ');
      }
      return `${topCounties.join(', ')} +${counties.length - 5} more`;
    }

    // Helper function to get county header display text for collapsed section
    function getCountyHeaderText(counties, allCounties) {
      if (allCounties) return 'All Counties';
      if (counties.length === 0) return 'No Counties';
      
      // Sort selected counties by population rank (most populous first)
      const sortedCounties = [...counties].sort((a, b) => {
        const aCounty = texasCounties.find(c => c.name === a);
        const bCounty = texasCounties.find(c => c.name === b);
        return (aCounty?.popRank || 999) - (bCounty?.popRank || 999);
      });
      
      const mostPopulous = sortedCounties[0];
      if (sortedCounties.length === 1) return `${mostPopulous} County`;
      return `${mostPopulous} County +${sortedCounties.length - 1} more`;
    }

    // Helper function to get case type display text for dropdown header
    function getCaseTypeDisplayText(selectedCases) {
      if (selectedCases.length === 0) return 'Select case types...';
      
      // Sort alphabetically
      const sortedCases = [...selectedCases].sort((a, b) => a.localeCompare(b));
      
      if (sortedCases.length <= 3) {
        return sortedCases.join(', ');
      }
      return `${sortedCases.slice(0, 3).join(', ')} +${sortedCases.length - 3} more`;
    }

    // Helper function to get case type header display text for collapsed section
    function getCaseTypeHeaderText(selectedCases) {
      if (selectedCases.length === 0) return 'No Case Types';
      
      // Sort alphabetically
      const sortedCases = [...selectedCases].sort((a, b) => a.localeCompare(b));
      
      if (sortedCases.length === 1) return sortedCases[0];
      if (sortedCases.length <= 3) {
        return sortedCases.join(', ');
      }
      return `${sortedCases.slice(0, 3).join(', ')} +${sortedCases.length - 3} more`;
    }

    // Helper function to generate case type options HTML
    function generateCaseTypeOptionsHTML(sectionId, selectedCases) {
      let optionsHTML = `
        <div class="multi-select-search">
          <input type="text" placeholder="Search case types..." onkeyup="filterCaseTypeOptions('${sectionId}', this.value)" aria-label="Search case types">
        </div>
      `;
      
      // Sort case types: selected items first (alphabetically), then unselected items (alphabetically)
      const selectedSorted = allCaseTypes.filter(ct => selectedCases.includes(ct)).sort((a, b) => a.localeCompare(b));
      const unselectedSorted = allCaseTypes.filter(ct => !selectedCases.includes(ct)).sort((a, b) => a.localeCompare(b));
      const sortedCaseTypes = [...selectedSorted, ...unselectedSorted];
      
      sortedCaseTypes.forEach(caseType => {
        const isChecked = selectedCases.includes(caseType);
        const caseTypeId = caseType.replace(/[\s\/]+/g, '-').toLowerCase();
        optionsHTML += `
          <div class="multi-select-option casetype-option" data-casetype="${caseType.toLowerCase()}">
            <input type="checkbox" id="${sectionId}-casetype-${caseTypeId}" ${isChecked ? 'checked' : ''} onchange="toggleCaseType('${sectionId}', '${caseType.replace(/'/g, "\\'")}', this.checked)">
            <label for="${sectionId}-casetype-${caseTypeId}">${caseType}</label>
          </div>
        `;
      });
      return optionsHTML;
    }

    // Toggle case type dropdown visibility
    function toggleCaseTypeDropdown(sectionId) {
      const dropdown = document.getElementById(`${sectionId}-casetype-options`);
      const allDropdowns = document.querySelectorAll('.multi-select-options');
      allDropdowns.forEach(d => {
        if (d.id !== `${sectionId}-casetype-options`) d.classList.remove('open');
      });
      dropdown.classList.toggle('open');
      if (dropdown.classList.contains('open')) {
        // Re-generate options to ensure proper sorting (selected first, then unselected)
        const section = sections.find(s => s.id === sectionId);
        if (section) {
          dropdown.innerHTML = generateCaseTypeOptionsHTML(sectionId, section.cases);
        }
        const searchInput = dropdown.querySelector('input[type="text"]');
        if (searchInput) searchInput.focus();
      }
    }

    // Filter case type options
    function filterCaseTypeOptions(sectionId, searchText) {
      const options = document.querySelectorAll(`#${sectionId}-casetype-options .casetype-option`);
      const lowerSearch = searchText.toLowerCase();
      options.forEach(opt => {
        const caseTypeName = opt.dataset.casetype;
        opt.style.display = caseTypeName.includes(lowerSearch) ? '' : 'none';
      });
    }

    // Toggle individual case type
    function toggleCaseType(sectionId, caseTypeName, checked) {
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;
      
      if (checked) {
        if (!section.cases.includes(caseTypeName)) {
          section.cases.push(caseTypeName);
        }
      } else {
        section.cases = section.cases.filter(c => c !== caseTypeName);
      }
      
      // Update display
      updateCaseTypeDisplay(sectionId);
      markSectionChanged(sectionId);
    }

    // Check if section has valid case type selection
    function hasValidCaseTypeSelection(section) {
      return section.cases.length > 0;
    }

    // Update case type display text
    function updateCaseTypeDisplay(sectionId) {
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;
      
      const displayText = getCaseTypeDisplayText(section.cases);
      const displayEl = document.getElementById(`${sectionId}-casetype-display`);
      if (displayEl) {
        displayEl.textContent = displayText;
        displayEl.classList.toggle('text-gray-400', section.cases.length === 0);
      }
      
      // Update the collapsed section summary
      updateSectionSummary(sectionId);
    }

    // Update section summary text in collapsed header
    function updateSectionSummary(sectionId) {
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;
      
      const countyHeaderText = getCountyHeaderText(section.counties, section.allCounties);
      const summary = `Max Capacities ${section.daily}d ${section.weekly}w ${section.monthly}m  ●  Max ${section.fpl}% FPL  ●  ${countyHeaderText}`;
      
      const summaryEl = document.querySelector(`[data-id="${sectionId}"] .collapsed-summary`);
      if (summaryEl) {
        summaryEl.textContent = summary;
      }
    }

    // Helper function to generate county options HTML
    function generateCountyOptionsHTML(sectionId, selectedCounties, allCounties) {
      let optionsHTML = `
        <div class="multi-select-search">
          <input type="text" placeholder="Search counties..." onkeyup="filterCountyOptions('${sectionId}', this.value)" aria-label="Search counties">
        </div>
        <div class="multi-select-option all-option">
          <input type="checkbox" id="${sectionId}-all-counties" ${allCounties ? 'checked' : ''} onchange="toggleAllCounties('${sectionId}', this.checked)">
          <label for="${sectionId}-all-counties">All counties</label>
        </div>
      `;
      
      // Sort counties: selected items first (alphabetically), then unselected items (alphabetically)
      const selectedSorted = texasCounties.filter(c => selectedCounties.includes(c.name)).sort((a, b) => a.name.localeCompare(b.name));
      const unselectedSorted = texasCounties.filter(c => !selectedCounties.includes(c.name)).sort((a, b) => a.name.localeCompare(b.name));
      const sortedCounties = [...selectedSorted, ...unselectedSorted];
      
      sortedCounties.forEach(county => {
        const isChecked = selectedCounties.includes(county.name);
        optionsHTML += `
          <div class="multi-select-option county-option" data-county="${county.name.toLowerCase()}">
            <input type="checkbox" id="${sectionId}-county-${county.name.replace(/\s+/g, '-')}" ${isChecked ? 'checked' : ''} ${allCounties ? 'disabled' : ''} onchange="toggleCounty('${sectionId}', '${county.name}', this.checked)">
            <label for="${sectionId}-county-${county.name.replace(/\s+/g, '-')}">${county.name}</label>
          </div>
        `;
      });
      return optionsHTML;
    }

    // Toggle dropdown visibility
    function toggleCountyDropdown(sectionId) {
      const dropdown = document.getElementById(`${sectionId}-county-options`);
      const allDropdowns = document.querySelectorAll('.multi-select-options');
      allDropdowns.forEach(d => {
        if (d.id !== `${sectionId}-county-options`) d.classList.remove('open');
      });
      dropdown.classList.toggle('open');
      if (dropdown.classList.contains('open')) {
        // Re-generate options to ensure proper sorting (selected first, then unselected)
        const section = sections.find(s => s.id === sectionId);
        if (section) {
          dropdown.innerHTML = generateCountyOptionsHTML(sectionId, section.counties, section.allCounties);
        }
        const searchInput = dropdown.querySelector('input[type="text"]');
        if (searchInput) searchInput.focus();
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.multi-select-dropdown')) {
        document.querySelectorAll('.multi-select-options').forEach(d => d.classList.remove('open'));
      }
    });

    // Filter county options
    function filterCountyOptions(sectionId, searchText) {
      const options = document.querySelectorAll(`#${sectionId}-county-options .county-option`);
      const lowerSearch = searchText.toLowerCase();
      options.forEach(opt => {
        const countyName = opt.dataset.county;
        opt.style.display = countyName.includes(lowerSearch) ? '' : 'none';
      });
    }

    // Toggle all counties
    function toggleAllCounties(sectionId, checked) {
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;
      
      section.allCounties = checked;
      if (checked) {
        section.counties = [];
      }
      
      // Update individual county checkboxes
      const countyCheckboxes = document.querySelectorAll(`#${sectionId}-county-options .county-option input[type="checkbox"]`);
      countyCheckboxes.forEach(cb => {
        cb.disabled = checked;
        if (checked) cb.checked = false;
      });
      
      // Update display
      updateCountyDisplay(sectionId);
    }

    // Toggle individual county
    function toggleCounty(sectionId, countyName, checked) {
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;
      
      if (checked) {
        if (!section.counties.includes(countyName)) {
          section.counties.push(countyName);
        }
      } else {
        section.counties = section.counties.filter(c => c !== countyName);
      }
      
      // Update display
      updateCountyDisplay(sectionId);
    }

    // Check if section has valid county selection
    function hasValidCountySelection(section) {
      return section.allCounties || section.counties.length > 0;
    }

    // Update county display text and active toggle state
    function updateCountyDisplay(sectionId) {
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;
      
      const displayText = getCountyDisplayText(section.counties, section.allCounties);
      const displayEl = document.getElementById(`${sectionId}-county-display`);
      if (displayEl) {
        displayEl.textContent = displayText;
        displayEl.classList.toggle('text-gray-400', !section.allCounties && section.counties.length === 0);
      }
      
      // Update active toggle state based on county selection
      updateActiveToggleState(sectionId);
    }

    // Update the Section Active toggle based on county validation
    function updateActiveToggleState(sectionId) {
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;
      
      const isValid = hasValidCountySelection(section);
      const activeToggle = document.getElementById(`${sectionId}-active-toggle`);
      const activeWarning = document.getElementById(`${sectionId}-active-warning`);
      const headerBadge = document.getElementById(`${sectionId}-header-badge`);
      
      if (activeToggle) {
        activeToggle.disabled = !isValid;
        activeToggle.closest('.toggle-switch').classList.toggle('opacity-50', !isValid);
        activeToggle.closest('.toggle-switch').classList.toggle('cursor-not-allowed', !isValid);
        
        // If no counties and currently active, force to inactive
        if (!isValid && section.active) {
          section.active = false;
          activeToggle.checked = false;
          if (headerBadge) {
            headerBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600';
            headerBadge.textContent = 'Inactive';
          }
        }
      }
      
      if (activeWarning) {
        activeWarning.classList.toggle('hidden', isValid);
      }
    }

    // Handle section active toggle change
    function toggleSectionActive(sectionId, checked) {
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;
      
      // Prevent activation if no counties selected
      if (checked && !hasValidCountySelection(section)) {
        const activeToggle = document.getElementById(`${sectionId}-active-toggle`);
        if (activeToggle) activeToggle.checked = false;
        return;
      }
      
      section.active = checked;
      
      // Update header badge
      const headerBadge = document.getElementById(`${sectionId}-header-badge`);
      if (headerBadge) {
        headerBadge.className = `px-2 py-1 rounded text-xs font-medium ${checked ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`;
        headerBadge.textContent = checked ? 'Active' : 'Inactive';
      }
    }

    // Toggle notification option (text, email, webhook)
    function toggleNotificationOption(sectionId, type, checked) {
      const option = document.getElementById(`${sectionId}-notify-${type}-option`);
      const field = document.getElementById(`${sectionId}-notify-${type}-field`);
      
      if (option) {
        option.classList.toggle('checked', checked);
      }
      if (field) {
        field.classList.toggle('active', checked);
        if (checked) {
          const input = field.querySelector('input');
          if (input) input.focus();
        }
      }
    }

    // Toggle attestation requirement and update badge
    function toggleAttestation(sectionId, checked) {
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;
      
      section.attestation = checked;
      
      // Update the attestation badge
      const badge = document.getElementById(`${sectionId}-attestation-badge`);
      if (badge) {
        badge.textContent = checked ? 'Yes' : 'No';
        badge.className = `px-2 py-1 rounded text-xs font-medium ${checked ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`;
      }
      
      markSectionChanged(sectionId);
    }

    // Validate counties selection on save
    function validateCounties() {
      let isValid = true;
      sections.forEach(s => {
        if (!s.allCounties && s.counties.length === 0) {
          isValid = false;
          const displayEl = document.getElementById(`${s.id}-county-display`);
          if (displayEl) {
            displayEl.closest('.multi-select-selected').classList.add('border-red-500');
          }
        }
      });
      return isValid;
    }

    // Update capacity value with validation constraints
    // Weekly cannot be less than Daily, Monthly cannot be less than Weekly
    function updateCapacity(sectionId, type, value) {
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;
      
      const dailySlider = document.getElementById(`${sectionId}-daily-slider`);
      const weeklySlider = document.getElementById(`${sectionId}-weekly-slider`);
      const monthlySlider = document.getElementById(`${sectionId}-monthly-slider`);
      const dailyVal = document.getElementById(`${sectionId}-daily-val`);
      const weeklyVal = document.getElementById(`${sectionId}-weekly-val`);
      const monthlyVal = document.getElementById(`${sectionId}-monthly-val`);
      
      if (type === 'daily') {
        section.daily = value;
        dailyVal.textContent = value;
        // If weekly is now less than daily, bump weekly up
        if (section.weekly < value) {
          section.weekly = value;
          weeklySlider.value = value;
          weeklyVal.textContent = value;
        }
        // If monthly is now less than weekly, bump monthly up
        if (section.monthly < section.weekly) {
          section.monthly = section.weekly;
          monthlySlider.value = section.weekly;
          monthlyVal.textContent = section.weekly;
        }
      } else if (type === 'weekly') {
        // Weekly cannot be less than daily
        const minWeekly = section.daily;
        const adjustedValue = Math.max(value, minWeekly);
        section.weekly = adjustedValue;
        weeklySlider.value = adjustedValue;
        weeklyVal.textContent = adjustedValue;
        // If monthly is now less than weekly, bump monthly up
        if (section.monthly < adjustedValue) {
          section.monthly = adjustedValue;
          monthlySlider.value = adjustedValue;
          monthlyVal.textContent = adjustedValue;
        }
      } else if (type === 'monthly') {
        // Monthly cannot be less than weekly
        const minMonthly = section.weekly;
        const adjustedValue = Math.max(value, minMonthly);
        section.monthly = adjustedValue;
        monthlySlider.value = adjustedValue;
        monthlyVal.textContent = adjustedValue;
      }
      
      // Update the collapsed section summary
      updateSectionSummary(sectionId);
      markSectionChanged(sectionId);
    }

    // Mark section as changed (enable Save button)
    function markSectionChanged(sectionId) {
      const saveBtn = document.getElementById(`${sectionId}-save-btn`);
      if (saveBtn) {
        saveBtn.disabled = false;
      }
    }

    // Save section changes
    function saveSection(sectionId) {
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;
      
      // Validate counties before saving
      if (!hasValidCountySelection(section)) {
        alert('Please select at least one county before saving.');
        return;
      }
      
      // In production, this would send data to the server
      // For now, just disable the button to indicate saved state
      const saveBtn = document.getElementById(`${sectionId}-save-btn`);
      if (saveBtn) {
        saveBtn.disabled = true;
        // Show brief "Saved!" feedback
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Saved!';
        setTimeout(() => {
          saveBtn.textContent = originalText;
        }, 1500);
      }
      
      console.log(`Section ${sectionId} saved:`, section);
    }

    // Initialize change tracking for a section after DOM is ready
    function initChangeTracking(sectionId) {
      const sectionEl = document.querySelector(`[data-id="${sectionId}"]`);
      if (!sectionEl) return;
      
      // Track changes on all form inputs within the section
      sectionEl.querySelectorAll('input, select, textarea').forEach(input => {
        const eventType = input.type === 'checkbox' || input.type === 'range' ? 'change' : 'input';
        input.addEventListener(eventType, () => markSectionChanged(sectionId));
      });
    }

    const container = document.getElementById('referral-sections');
    sections.forEach(s => {
      const countyDisplayText = getCountyDisplayText(s.counties, s.allCounties);
      const countyHeaderText = getCountyHeaderText(s.counties, s.allCounties);
      const caseTypeDisplayText = getCaseTypeDisplayText(s.cases);
      const summary = `Max Capacities ${s.daily}d ${s.weekly}w ${s.monthly}m  ●  Max ${s.fpl}% FPL  ●  ${countyHeaderText}`;
      container.innerHTML += `
        <div class="collapsible-section bg-white rounded-lg shadow-sm overflow-hidden" data-id="${s.id}">
          <div class="collapsible-header p-4 flex items-center gap-4 hover:bg-gray-50" onclick="this.parentElement.classList.toggle('open')">
            <svg class="twistie w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            <div class="w-3 h-3 rounded-full bg-${s.color}-500 flex-shrink-0"></div>
            <div class="flex-1 min-w-0">
              <h3 class="font-semibold text-primary-800">${s.name}</h3>
              <p class="text-sm text-gray-500 truncate collapsed-summary">${summary}</p>
            </div>
            <div class="flex items-center gap-3" onclick="event.stopPropagation()">
              <button id="${s.id}-save-btn" class="text-xs px-2 py-1 bg-primary-600 text-white rounded hover:bg-primary-700 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed transition-colors" disabled onclick="saveSection('${s.id}')" aria-label="Save ${s.name} settings">Save</button>
              <label class="toggle-switch ${!s.allCounties && s.counties.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}"><input type="checkbox" id="${s.id}-active-toggle" ${s.active?'checked':''} ${!s.allCounties && s.counties.length === 0 ? 'disabled' : ''} onchange="toggleSectionActive('${s.id}', this.checked)"><span class="toggle-slider"></span></label>
              <span id="${s.id}-header-badge" class="px-2 py-1 rounded text-xs font-medium ${s.active?'bg-green-100 text-green-800':'bg-gray-100 text-gray-600'}">${s.active?'Active':'Inactive'}</span>
            </div>
          </div>
          <div class="collapsible-content">
            <div class="p-4 pt-0 border-t border-gray-100">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div><label class="block text-sm font-medium mb-1">Referral Channel Name<span class="help-icon" aria-label="Help">?<span class="tooltip">This is any user specified name that will help you easily identify the purpose of this Referral Channel. A value is required.</span></span></label><input type="text" class="form-control" value="${s.name}"></div>
                <div><label class="block text-sm font-medium mb-1">Max Poverty Level (%)<span class="help-icon" aria-label="Help">?<span class="tooltip">The intake process will determine the client's poverty level using household size and household income information provided by the client. A referral will not be sent to the Provider using this Referral Channel if the referral's poverty level exceeds the Max Poverty Level value.</span></span></label><input type="number" class="form-control" value="${s.fpl}" min="0" max="400"></div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium mb-1">Case Types<span class="help-icon" aria-label="Help">?<span class="tooltip">Select which case types this referral channel serves. At least 1 case type is required. A referral will not be sent to Provider using this Referral Channel unless the referral's case type is selected.</span></span></label>
                  <div class="multi-select-dropdown">
                    <div class="multi-select-selected" onclick="toggleCaseTypeDropdown('${s.id}')" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-label="Select case types">
                      <span id="${s.id}-casetype-display" class="${s.cases.length === 0 ? 'text-gray-400' : ''}">${caseTypeDisplayText}</span>
                      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </div>
                    <div class="multi-select-options" id="${s.id}-casetype-options" role="listbox">
                      ${generateCaseTypeOptionsHTML(s.id, s.cases)}
                    </div>
                  </div>
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium mb-1">Counties Served<span class="help-icon" aria-label="Help">?<span class="tooltip">Select which Texas counties this referral channel serves. Choose "All counties" or select specific counties. At least one option is required.</span></span></label>
                  <div class="multi-select-dropdown">
                    <div class="multi-select-selected" onclick="toggleCountyDropdown('${s.id}')" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-label="Select counties served">
                      <span id="${s.id}-county-display" class="${!s.allCounties && s.counties.length === 0 ? 'text-gray-400' : ''}">${countyDisplayText}</span>
                      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </div>
                    <div class="multi-select-options" id="${s.id}-county-options" role="listbox">
                      ${generateCountyOptionsHTML(s.id, s.counties, s.allCounties)}
                    </div>
                  </div>
                </div>
              </div>
              <div class="settings-group mt-6">
                <div class="settings-group-header">
                  <span class="settings-group-title">Capacity Meters</span>
                  <span class="help-icon" aria-label="Help">?<span class="tooltip">Set each capacity meter. If the number of referrals is at or exceeds any one of the capacity meters, then this Referral Channel is not currently eligible for referrals.</span></span>
                </div>
                <div class="space-y-4">
                  <div><label class="block text-sm font-medium mb-2">Daily Max Referrals: <span class="text-primary-600 font-bold" id="${s.id}-daily-val">${s.daily}</span></label><input type="range" id="${s.id}-daily-slider" min="0" max="20" value="${s.daily}" oninput="updateCapacity('${s.id}', 'daily', parseInt(this.value))"></div>
                  <div><label class="block text-sm font-medium mb-2">Weekly Max Referrals: <span class="text-primary-600 font-bold" id="${s.id}-weekly-val">${s.weekly}</span></label><input type="range" id="${s.id}-weekly-slider" min="0" max="50" value="${s.weekly}" oninput="updateCapacity('${s.id}', 'weekly', parseInt(this.value))"></div>
                  <div><label class="block text-sm font-medium mb-2">Monthly Max Referrals: <span class="text-primary-600 font-bold" id="${s.id}-monthly-val">${s.monthly}</span></label><input type="range" id="${s.id}-monthly-slider" min="0" max="100" value="${s.monthly}" oninput="updateCapacity('${s.id}', 'monthly', parseInt(this.value))"></div>
                </div>
              </div>
              <div class="settings-group mt-6">
                <div class="settings-group-header">
                  <span class="settings-group-title">Notification Preferences</span>
                </div>
                <div class="notification-option ${s.notifyText ? 'checked' : ''}" id="${s.id}-notify-text-option">
                  <div class="notification-option-header">
                    <input type="checkbox" id="${s.id}-notify-text" ${s.notifyText ? 'checked' : ''} onchange="toggleNotificationOption('${s.id}', 'text', this.checked)">
                    <label for="${s.id}-notify-text" class="font-medium">Text Message</label>
                    <span class="help-icon" aria-label="Help">?<span class="tooltip">If you'd like to receive a text message when you receive a referral from this Referral Channel, then enter the 10-digit phone number in the field. For multiple phone numbers, separate each with a comma.</span></span>
                  </div>
                  <div class="notification-input-field ${s.notifyText ? 'active' : ''}" id="${s.id}-notify-text-field">
                    <input type="tel" placeholder="e.g., 512-555-1234" value="${s.notifyTextValue}" class="form-control">
                  </div>
                </div>
                <div class="notification-option ${s.notifyEmail ? 'checked' : ''}" id="${s.id}-notify-email-option">
                  <div class="notification-option-header">
                    <input type="checkbox" id="${s.id}-notify-email" ${s.notifyEmail ? 'checked' : ''} onchange="toggleNotificationOption('${s.id}', 'email', this.checked)">
                    <label for="${s.id}-notify-email" class="font-medium">Email</label>
                    <span class="help-icon" aria-label="Help">?<span class="tooltip">If you'd like to receive an email when you receive a referral from this Referral Channel, then enter the email address in the field. For multiple email addresses, separate each with a comma.</span></span>
                  </div>
                  <div class="notification-input-field ${s.notifyEmail ? 'active' : ''}" id="${s.id}-notify-email-field">
                    <input type="email" placeholder="e.g., intake@organization.org" value="${s.notifyEmailValue}" class="form-control">
                  </div>
                </div>
                <div class="notification-option ${s.notifyWebhook ? 'checked' : ''}" id="${s.id}-notify-webhook-option">
                  <div class="notification-option-header">
                    <input type="checkbox" id="${s.id}-notify-webhook" ${s.notifyWebhook ? 'checked' : ''} onchange="toggleNotificationOption('${s.id}', 'webhook', this.checked)">
                    <label for="${s.id}-notify-webhook" class="font-medium">Webhook</label>
                    <span class="help-icon" aria-label="Help">?<span class="tooltip">If you'd like to execute a webhook when you receive a referral from this Referral Channel, then enter the URL of the webhook in the field. The referral data will be sent via POST in JSON format. Please see the documentation for the structure of the post data.</span></span>
                  </div>
                  <div class="notification-input-field ${s.notifyWebhook ? 'active' : ''}" id="${s.id}-notify-webhook-field">
                    <input type="url" placeholder="e.g., https://api.example.org/referrals" value="${s.notifyWebhookValue}" class="form-control">
                  </div>
                </div>
              </div>
              <p id="${s.id}-active-warning" class="text-sm text-amber-600 mt-4 flex items-center gap-1 ${s.allCounties || s.counties.length > 0 ? 'hidden' : ''}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>Select at least one county to activate this section</p>
              <div class="mt-4 flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div><p class="font-medium">Require Client Attestation<span class="help-icon" aria-label="Help">?<span class="tooltip">If 'Yes', then the client must eSign an attestation document containing their poverty information and other eligibility criteria before a referral is sent. The attestation document and other information will be available to you with the referral.</span></span></p></div><div class="flex items-center gap-3"><label class="toggle-switch"><input type="checkbox" id="${s.id}-attestation-toggle" ${s.attestation?'checked':''} onchange="toggleAttestation('${s.id}', this.checked)"><span class="toggle-slider"></span></label><span id="${s.id}-attestation-badge" class="px-2 py-1 rounded text-xs font-medium ${s.attestation?'bg-green-100 text-green-800':'bg-gray-100 text-gray-600'}">${s.attestation?'Yes':'No'}</span></div></div>
            </div>
          </div>
        </div>`;
    });

    // Initialize change tracking for all sections after DOM is ready
    sections.forEach(s => initChangeTracking(s.id));
  </script>
  <script>
    // Resizable sidebar functionality
    (function() {
      const MIN_WIDTH = 200;
      const MAX_WIDTH = 400;
      const STORAGE_KEY = 'portal-sidebar-width';
      
      const sidebar = document.getElementById('portal-sidebar');
      const resizer = document.getElementById('sidebar-resizer');
      const portalLayout = document.querySelector('.portal-layout');
      
      if (!sidebar || !resizer || !portalLayout) return;
      
      // Load saved width from localStorage
      const savedWidth = localStorage.getItem(STORAGE_KEY);
      if (savedWidth) {
        const width = parseInt(savedWidth, 10);
        if (width >= MIN_WIDTH && width <= MAX_WIDTH) {
          portalLayout.style.setProperty('--sidebar-width', width + 'px');
        }
      }
      
      let isResizing = false;
      
      resizer.addEventListener('mousedown', function(e) {
        isResizing = true;
        resizer.classList.add('dragging');
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        
        let newWidth = e.clientX;
        newWidth = Math.max(MIN_WIDTH, Math.min(MAX_WIDTH, newWidth));
        
        portalLayout.style.setProperty('--sidebar-width', newWidth + 'px');
      });
      
      document.addEventListener('mouseup', function() {
        if (isResizing) {
          isResizing = false;
          resizer.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
          
          // Save to localStorage
          const currentWidth = getComputedStyle(portalLayout).getPropertyValue('--sidebar-width');
          localStorage.setItem(STORAGE_KEY, parseInt(currentWidth, 10));
        }
      });
    })();
  </script>
</body>
</html>
